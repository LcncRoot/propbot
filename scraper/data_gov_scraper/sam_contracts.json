import requests
import json
import os
from datetime import datetime, timedelta

# SAM.gov API Endpoint
SAM_API_URL = "https://api.sam.gov/opportunities/v2/search"
SAM_DESCRIPTION_URL = "https://api.sam.gov/prod/opportunities/v1/noticedesc"
SAM_API_KEY = "vzbgHmOMSYexaLBCKeyc8UH7GWcRyB5TLW9tBcc0"

# Database file
DATABASE_FILE = "sam_contracts.json"

def fetch_sam_contract():
    """Fetch ONLY ONE contract opportunity from SAM.gov API for testing."""
    today = datetime.today()
    one_year_ago = today - timedelta(days=365)

    posted_from = one_year_ago.strftime("%m/%d/%Y")
    posted_to = today.strftime("%m/%d/%Y")

    params = {
        "api_key": SAM_API_KEY,
        "postedFrom": posted_from,
        "postedTo": posted_to,
        "limit": 1,  # Fetch ONLY ONE contract
        "offset": 0,  # Start from the first contract
    }

    response = requests.get(SAM_API_URL, params=params)

    if response.status_code == 200:
        data = response.json()
        contracts = data.get("opportunitiesData", [])

        if not contracts:
            print("✅ No contracts found.")
            return

        # Fetch full description for the contract
        contract = contracts[0]
        notice_id = contract.get("noticeId")
        if notice_id:
            contract["fullDescription"] = fetch_contract_description(notice_id)
        
        save_contract_to_db(contract)
        print(f"✅ Successfully fetched and saved one contract.")

    else:
        print(f"❌ Error fetching SAM.gov contract: {response.status_code}")
        print(f"Response: {response.text}")

def fetch_contract_description(notice_id):
    """Fetch the full contract description using the noticedesc API."""
    params = {
        "noticeid": notice_id,
        "api_key": SAM_API_KEY,
    }
    response = requests.get(SAM_DESCRIPTION_URL, params=params)

    if response.status_code == 200:
        data = response.json()
        return data.get("description", "No description available.")
    else:
        print(f"❌ Error fetching description for {notice_id}: {response.status_code}")
        return "No description available."

def save_contract_to_db(contract):
    """Save a single fetched contract to a JSON database."""
    existing_contracts = []

    if os.path.exists(DATABASE_FILE):
        with open(DATABASE_FILE, "r") as f:
            try:
                existing_contracts = json.load(f)
            except json.JSONDecodeError:
                pass  # Ignore JSON errors (if file is empty)

    # Ensure we don’t store duplicates
    contract_ids = {c["noticeId"] for c in existing_contracts}
    if contract["noticeId"] not in contract_ids:
        existing_contracts.append(contract)

    with open(DATABASE_FILE, "w") as f:
        json.dump(existing_contracts, f, indent=4)

    print(f"✅ Saved one new contract to database.")

if __name__ == "__main__":
    fetch_sam_contract()
